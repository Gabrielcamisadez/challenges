#+title: Verdejo
#+author: gabriel
#+description: Verdejo easy level from dockerlabs.es

*** machine setup

*give permissions to the file* ->
#+begin_src sh
chmod +x auto_deploy.sh
#+end_src

*initial scan* ->
#+begin_src sh
nmap -vv -T5 172.17.0.2

Nmap scan report for 172.17.0.2
Host is up, received syn-ack (0.00038s latency).
Scanned at 2025-09-21 12:22:11 -03 for 0s
Not shown: 997 closed tcp ports (conn-refused)
PORT     STATE SERVICE REASON
22/tcp   open  ssh     syn-ack
80/tcp   open  http    syn-ack
8089/tcp open  unknown syn-ack
#+end_src

** SSTI - Server Side Template Injection

Is a vulnerability that occurs when an attacker can inject malicious code into a template that is executed on the server.

This vulnerability can be found in various technologies, including Jinja
#+begin_src python
output = template.render(name=request.args.get('name'))
#+end_src

This code is vulnerable, tha name parameter form te user request is directly passed into the template using the render function.

This can potentially allow an attacker to inject malicious code into the name parameter, leading to server-side template injection.

 * at this case, an attacker could craft a request with a payload like this ->
   #+begin_src sh
https://vulnerable-site.com/?name={{payload}}
   #+end_src

This payload could contains Jinja template directives that enable the attacker to execute unauthorized code or manipulate the template engine.


** Detection

To detect Server-Side Template Injection, initially, fuzzing the template is a straightforward approach. This involves injecting a sequence of special caracters *(${{<%[%'"]}%\})* into the template and analyzing the differences in the server response to regular data versus this special payload. Vulnerability indicators include:

- Thrown errors, revealing the vulnerability and potentially the template engine
- Absence of the payload in the reflection, or parts of it missing, implying the server processes it differentyl than regular data.

- *Plaintext Context*  -> Distinguish from XSS by checking if the server evaluates template expressions *({{ 7 * 7 }}, ${ 7 * 7  })*

- *Code Context* -> Confirm vulnerability by altering input parameters.

** Some tools

Hackmanit/TInjA - An efficient SSTI + CSTI scanner which utilizes novel polyglots
 * https://github.com/Hackmanit/TInjA

epinna/tplmap - Server-Side Template Injection and Code Injection Detection and Exploitation Tool
 * https://github.com/epinna/tplmap

vladko312/SSTImap - Automatic SSTI detection tool with interactive interface based on epinna/tplmap
 * https://github.com/vladko312/SSTImap


** Methodology

Identify the vulnerable input field

The attacker first locates an input field, URL parameter, or any user-controllable part of the application that is passed into a server-side template without sanitization or escaping.

Different web frameworks use different template engines (e.g., Jinja2 for Python, Twig for PHP, or FreeMarker for Java).

Common template expressions:

*{{7*7}} for Jinja2 (Python).*
*#{7*7} for Thymeleaf (Java).*


*** detection flowchart ->

[[../verdejo/imgs/detection.png]]



*** detection flowchart 2 ->
[[../verdejo/imgs/serverside-flowchart.png]]
